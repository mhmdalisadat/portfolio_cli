name: Deploy Portfolio to Server

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            echo "ğŸš€ Starting deployment..."

            # Setup project directory
            mkdir -p /var/pro/portfolio_cli
            cd /var/pro/portfolio_cli

            # Update repository
            if [ -d ".git" ]; then
              echo "ğŸ”„ Updating repository..."
              git reset --hard HEAD
              git clean -fd
              git pull origin main
            else
              echo "ğŸ”„ Cloning repository..."
              git clone https://${{ secrets.GITHUB_TOKEN }}@github.com/mhmdalisadat/portfolio_cli.git .
            fi

            # Install Docker if needed
            if ! command -v docker >/dev/null 2>&1; then
              echo "ğŸ“¦ Installing Docker..."
              curl -fsSL https://get.docker.com -o get-docker.sh
              sudo sh get-docker.sh
            fi

            # Deploy with Docker Compose
            echo "ğŸ›‘ Stopping existing containers..."
            docker compose down || true

            echo "âš™ï¸ Building and starting container..."
            docker compose up -d --build frontend

            echo "ğŸ“¦ Container status:"
            docker compose ps

            echo "âœ… Deployment completed!"
