name: Deploy Farasite Next.js to Ubuntu Server

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: SSH and Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            echo "ğŸš€ Starting Farasite deployment..."

            # Ø±ÙØªÙ† Ø¨Ù‡ Ù…Ø³ÛŒØ± Ø§ØµÙ„ÛŒ Ø³Ø±ÙˆØ±
            cd /var/www/

            # Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù¾ÙˆØ´Ù‡ Ù‚Ø¨Ù„ÛŒ
            rm -rf farasite_next
            mkdir -p farasite_next
            cd farasite_next

            # Ú©Ù„ÙˆÙ† Ú©Ø±Ø¯Ù† Ø¢Ø®Ø±ÛŒÙ† Ù†Ø³Ø®Ù‡ Ø§Ø² Ù¾Ø±ÙˆÚ˜Ù‡
            echo "ğŸ“¥ Cloning latest Farasite repository..."
            git clone --depth 1 https://github.com/isatispooya/farasite_cli.git . || { echo "âŒ Git clone failed"; exit 1; }

            # Ù†ØµØ¨ Ù¾Ú©ÛŒØ¬â€ŒÙ‡Ø§
            echo "ğŸ“¦ Installing dependencies..."
            rm -rf node_modules package-lock.json
            npm install || { echo "âŒ npm install failed"; exit 1; }

            # Ø¨ÛŒÙ„Ø¯ Ù¾Ø±ÙˆÚ˜Ù‡
            echo "ğŸ”¨ Building the Next.js app..."
            npm run build || { echo "âŒ Build failed"; exit 1; }

            # Ø±ÛŒØ³ØªØ§Ø±Øª Ø³Ø±ÙˆÛŒØ³ PM2 Ø±ÙˆÛŒ Ù¾ÙˆØ±Øª 8085
            echo "â™»ï¸ Restarting PM2 process on port 8085..."next

            pm2 delete farasite_next || echo "â„¹ï¸ No existing PM2 process found"
            NODE_ENV=production NODE_NO_WARNINGS=1 pm2 start "npm run start -- -p 8085" --name farasite_next || { echo "âŒ PM2 start failed"; exit 1; }

            # Ø°Ø®ÛŒØ±Ù‡ ÙˆØ¶Ø¹ÛŒØª PM2
            pm2 save || { echo "âŒ PM2 save failed"; exit 1; }

            echo "âœ… Farasite deployment completed successfully on port 8085"
